<!DOCTYPE html>
<html lang="en-US"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">




<title>Final Documentation – Mikayla Fischler – D19 LIGHT ART</title>






		
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	



<link rel="stylesheet" id="wp-block-library-css" href="/lightartfp/Final%20Documentation_files/style_002.css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="/lightartfp/Final%20Documentation_files/genericons.css" type="text/css" media="all"><link rel="stylesheet" id="dyad-fonts-css" href="/lightartfp/Final%20Documentation_files/css.css" type="text/css" media="all">
<link rel="stylesheet" id="dyad-style-css" href="/lightartfp/Final%20Documentation_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="/lightartfp/Final%20Documentation_files/jetpack.css" type="text/css" media="all">




 









<style type="text/css">img#wpstats{display:none}</style>		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		<style type="text/css">
.avatar {vertical-align:middle; margin-right:5px;}
.credit {font-size: 50%;}
</style>
		<style type="text/css" media="print">#wpadminbar { display:none; }</style>
	<style type="text/css" media="screen">
	html { margin-top: 32px !important; }
	* html body { margin-top: 32px !important; }
	@media screen and ( max-width: 782px ) {
		html { margin-top: 46px !important; }
		* html body { margin-top: 46px !important; }
	}
</style>
	


















</head>

<body class="post-template-default single single-post postid-1040 single-format-standard logged-in admin-bar no-customize-support group-blog is-singular has-post-thumbnail not-scrolled">
<div id="page" class="hfeed site">
	

	

	<div class="site-inner">

		
		<div id="content" class="site-content" style="padding-top: 50px;">

	<main id="primary" class="content-area" role="main">

		
			
<article id="post-1040" class="post-1040 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
			
		<div class="entry-media" style="background-image: url(http://www.joshuarosenstock.com/teaching/lightart-d19/wp-content/uploads/sites/9/2019/04/20190429_210934-wp-960x1280.jpg)">
			<div class="entry-media-thumb" style="background-image: url(http://www.joshuarosenstock.com/teaching/lightart-d19/wp-content/uploads/sites/9/2019/04/20190429_210934-wp-960x640.jpg); "></div>
		</div><!-- .entry-media -->
	

	<div class="entry-inner">

		<header class="entry-header">
			<div class="entry-meta">
							</div><!-- .entry-meta -->

			<h1 class="entry-title">Final Documentation – Mikayla Fischler</h1>
			<!-- .entry-posted -->
		</header><!-- .entry-header -->

		<div class="entry-content">
			
<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190429_210934-wp-1024x576.jpg" alt="" class="wp-image-1125" ></figure>



<h2>Abstract and Introduction</h2>



<p>To complete my HUA requirement for WPI, I decided to take Light Art 
as it caught my interest due to my passion for electronics and LEDs. The
 project I came up with is an LED audio visualizer in the shape of a 
cloud that is covered in cotton balls. This became known as the “Sound 
Cloud”.</p>



<p>This project took a few weeks to complete and I am very happy with 
the result. Through different modes, there is a effective visualizer for
 almost every song and every genre. This provides a wonderful light show
 to go along with your music, and can even light up a room if it is dark
 enough.</p>



<p>I had a lot of fun (and a lot of challenges) when creating this 
project, and look forward to future iterations as I plan to keep, 
maintain, and improve this project as it is very enjoyable to have 
running. </p>



<p>This documentation likely extends far beyond the requirements and 
expectations, but I felt as though I wanted to explain all aspects of my
 project in addition to sharing the results. I will begin with sharing 
the results.</p>



<h2>Gallery</h2>



<h4>Simple Animations</h4>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190429_210958-wp-1024x576.jpg" alt="" class="wp-image-1126" ><figcaption>Simple Bass Pulse</figcaption></figure>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190429_211015-wp-1024x576.jpg" alt="" class="wp-image-1127" ><figcaption>Bass Range Pulse</figcaption></figure>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190429_211027-wp-1024x576.jpg" alt="" class="wp-image-1128" ><figcaption>Bass Treble Pulse</figcaption></figure>



<h4>Advanced Animations</h4>



<ul class="wp-block-gallery columns-3 is-cropped"><li class="blocks-gallery-item"><figure><img src="/lightartfp/Final%20Documentation_files/20190429_205633-wp-1024x576.jpg" alt="" data-id="1129"  ><figcaption>Rainbow Linear Visualizer</figcaption></figure></li></ul>



<ul class="wp-block-gallery columns-2 is-cropped"><li class="blocks-gallery-item"><figure><img src="/lightartfp/Final%20Documentation_files/20190429_211057-wp-1024x576.jpg" alt="" data-id="1134"  ><figcaption>Fire Linear Visualizer</figcaption></figure></li></ul>



<h2>Demonstrations</h2>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/4Xnykg5cFrI.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/upcYEHSZOjg.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/Ohv_1EnkJ7Y.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>


<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/Yv6PKMnselo.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/-cmI66tLaew.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/VTfBElKl41E.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/7BubiTOT2Co.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper">
	<span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/l--WsFysLW4.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/2PeZTF4Ok6Y.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/ahTeyukWisA.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>




<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/UI8912N4Yrk.html" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>



<h2>Structure</h2>



<ul class="wp-block-gallery columns-2 is-cropped"><li class="blocks-gallery-item"><figure><img src="/lightartfp/Final%20Documentation_files/20190427_233120-wp-1024x576.jpg" alt="" data-id="1079"  ></figure></li></ul>



<p>The structure of the cloud consists of 4 key materials and a lot of 
hot glue. The base is a set of cut-up cardboard boxes hot glued together
 into the desired base size, which was sculpted before hand by hand 
using wire mesh. The overall structure was defined by using wire mesh, 
which was reinforced by the aforementioned cardboard in the base. The 
base also has 4 rubber feet mounted to both prevent the cloud from 
sliding and provide space to reach under when picking it up.</p>



<p>On the sides and top of the cloud, a layer of thermoplastic was 
applied, giving a moderately strong plastic shell to the project. This 
plastic is slightly flexible, therefore not at all brittle, and it takes
 a lot of force to deform or fracture it, which is good as I want this 
project to last.</p>



<p>Layered on the front, top, and sides are over 300 cotton balls. These
 are mostly glued onto LED strips (which will be mentioned later), but 
in some cases they are just directly mounted to the thermoplastic shell.
 They are all attached with hot glue both to the shell and to the 
adjacent cotton balls.</p>



<h2>Electrical Hardware</h2>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233227-wp-1024x576.jpg" alt="" class="wp-image-1078" ><figcaption>Picture of the internals</figcaption></figure>



<p>The electrical hardware of this project consists of inputs, outputs, assistive circuits, and processing and control boards.</p>



<h3><em>Input and Output (I/O)</em></h3>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233154-wp-1024x576.jpg" alt="" class="wp-image-1108" ><figcaption>I/O Panel on the rear of the cloud</figcaption></figure>



<p>On the rear of the cloud is the I/O panel. To the left we have power 
related things, specifically the 5v DC barrel jack connector and the 
power switch. This is the source of power for the whole system, which 
runs through a 10 Amp fuse that can be seen in the first hardware 
picture all the way to the right middle of the box. In the case of a 
short, this should prevent an unexpected amount of current from being 
drawn. This may be lowered in the future, but in theory at max 
brightness, 8-9 Amps could be drawn.</p>



<p>Next, there is the speaker selector switch, which is deprecated. This
 has labels int and ext, corresponding to internal and external speaker 
selection. The circuit for this did not work, and instead of replacing 
it with something I knew would work, I instead opted for having both 
outputs live at once, since the internal speakers could be completely 
silenced with the volume knob.</p>



<p>Two very important ports are the two holes near the bottom. These are
 the 3.5mm audio jacks, left being input and right being output (for 
external speaker/headphone output). The input is split to go to the 
audio amplifier for the internal speakers, the audio processing board, 
and the output line.</p>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233312-wp-1024x576.jpg" alt="" class="wp-image-1110" ><figcaption>Internal view of the I/O panel</figcaption></figure>



<p>The blue knob on the back controls volume, and the white knob 
currently controls nothing, but may instead soon have some sort of 
purpose. The volume knob is a dual (separate signals for left and right 
but controlled equally) 10K ohm logarithmic potentiometer. Audio systems
 use logarithmic control since <a href="https://www.epd.gov.hk/epd/noise_education/web/ENG_EPD_HTML/m1/intro_5.html">humans perceive audio on a logarithmic scale</a>.</p>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/debouncer-wp-1024x476.jpg" alt="" class="wp-image-1115" ><figcaption>Mode button de-bouncer circuit</figcaption></figure>



<p>Finally, the mode button and status LED are the on the right most 
side of the panel. The mode button switches the current animation with 
each press, and the status LED describes the system state, which is 
described later in the Software section. The mode button also has a 
hardware de-bouncer circuit which is shown above.This consists of a 1K 
ohm resistor from de-bounced signal to controller input, a 470 ohm 
resistor from Vcc to the de-bounce signal, and a 1uF capacitor from the 
signal to ground. This setup forms a <a href="https://hackaday.com/2015/12/09/embed-with-elliot-debounce-your-noisy-buttons-part-i/">de-bouncer circuit</a>, with hysteresis implemented in code (to be discussed in the Software section).</p>



<h3><em>Assistive Circuits</em></h3>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233227_assistive-wp-1024x535.jpg" alt="" class="wp-image-1111" ><figcaption>Power distribution, regulation, and audio amplifier</figcaption></figure>



<h4>Power Distribution and Regulation</h4>



<p>The rightmost soldered board consists of multiple circuits, but in 
the end is purely for power distribution. It also contains an orange LED
 which lights up when power is available, and will dim if too much 
current is being drawn, which was helpful for debugging. </p>



<p>The breadboard section at the top continues this, providing for the 
ground connection of numerous boards and the power to the LED logic 
level shifter. Both the power distribution board and the bar have their 
own 1000uF capacitors to stabilize the power rails and reduce audio 
noise due to power supply stress.</p>



<h4>Audio Amplification</h4>



<p>At the bottom left of the above image is the 3.1 Watt audio amplifier
 board. This board is class D so it generates very little heat, which is
 good as it is sitting in an insulated box. This board amplifies the 
audio input signal and provides enough current to drive the two 
speakers, which are connected over 14 AWG stranded copper wire for 
better audio fidelity (even though the speakers and general acoustics 
are not exactly professional grade).</p>



<h3>Processing and Control Boards</h3>



<h4>Teensy Audio Board</h4>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233300-wp-1024x576.jpg" alt="" class="wp-image-1114" ></figure>



<p>To start off, this <a href="https://www.pjrc.com/store/teensy3_audio.html">board</a>
 is one of the best devices I have ever worked with. Its audio 
capabilities are endless, and I would highly recommend it to anyone who 
wants to do anything with audio. Playback, generation, analysis? It has 
all of that.</p>



<p>For this application, it is hooked up to the micro-controller (the 
next sub-section) and provides a 1024-bit Fast Fourier Transform 
(discussed in the software section). The audio line input is connected 
to the line input, and data lines connect it to the micro-controller.</p>



<h4>Teensy 3.6 Micro-controller</h4>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/20190427_233252-wp-1024x576.jpg" alt="" class="wp-image-1117" ><figcaption>Teensy 3.6 board with its own 1000uF capacitor across Vcc and GND</figcaption></figure>



<p>The <a href="https://www.pjrc.com/store/teensy36.html">Teensy 3.6</a>
 is a beast of a micro-controller when compared to its Arduino cousins. 
At 180 MHz and a dedicated FPU (floating point unit, for processing 
floating point math), it is able to execute any floating point math and 
complex conditional array accesses that I throw at it with ease. The 
only slow downs I have encountered are the time it takes to actually 
update the strip (which can be eliminated with <a href="https://en.wikipedia.org/wiki/Direct_memory_access">DMA</a>) and the delay to receive FFT data, which is all discussed more in depth in the software section.</p>



<p>This board runs at 3.3 volts, and to ensure proper signal transmission to the LEDs, a <a href="https://www.adafruit.com/product/3877">3.3v to 5v logic level shifter</a> is used (shown in the top right of the above image).</p>



<h2>Software</h2>



<h3><em>Overview of the Code</em></h3>



<p>The software for this project was developed in C/C++ using the <a href="https://www.arduino.cc/en/Main/Software">Arduino IDE</a> for compilation and <a href="https://code.visualstudio.com/">Visual Studio Code</a> for development. In order to work with the <a href="https://www.pjrc.com/teensy/">Teensy</a>, the <a href="https://www.pjrc.com/teensy/teensyduino.html">Teensyduino</a> software was installed, providing the Teensy program loader which loaded the compiled files to the Teensy.<br><br>The basis for this entire program is the usage of the <a href="https://www.pjrc.com/store/teensy3_audio.html">Teensy Audio Board</a>, mentioned in the prior Hardware section. Connecting to this board from the Teensy using <a href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C</a>
 communication allowed the core program to receive Fast Fourier 
Transforms (FFTs) about every 10ms, resulting in a very smooth 
visualization.<br><br>The program runs in a minimally <a href="https://en.wikipedia.org/wiki/Blocking_(computing)">blocking</a>
 state, only blocking when waiting for FFT data (after performing all 
necessary calculations and writing the output to the LEDs, the latter 
taking up 99% of the 4-6ms that this step takes). Since it is minimally 
blocking, it is able to check for mode changes about every 8-10ms, which
 is often enough. <br><br>Mode changing as mentioned before is done with a button on the back, which is attached to an <a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a>.
 When the button is pressed and the signal edge falls, it calls a 
function in the code to increment the mode (or wrap around to the 
beginning). Due to some slight noise after hardware de-bouncing, a 
simple software de-bouncer is implemented, which will be described 
later.</p>



<h3><em>Fast Fourier Transform</em></h3>



<p>A <a href="https://en.wikipedia.org/wiki/Fast_Fourier_transform">Fast Fourier Transform (FFT)</a>
 is a method of quickly performing a Fourier Transform to analyze 
signals such as audio signals. Different bits of resolution provide 
different frequency precision. </p>



<p>In this case, a 1024-bit FFT provides 512 single-precision floating 
point values from 0.0 to 1.0. This spans 0 Hz to 22000 KHz, providing a 
frequency resolution of 43 Hz per frequency bin. This allows the code to
 average together or sum ranges of frequencies and use those to 
accurately display components of audio onto the LEDs.</p>



<h3><em>LED Mapping</em></h3>



<figure class="wp-block-image"><img src="/lightartfp/Final%20Documentation_files/led_map-1024x508.png" alt="" class="wp-image-1122" ><figcaption>LED Map</figcaption></figure>



<p>Mapping the three LED strips onto a 3-dimensional surface was one of 
the biggest challenges of this project. After brainstorming and some 
failed ideas, I decided to throw everything into a spreadsheet and work 
something out. In the graphic above, each color represents a different 
LED strip and each number represents the index of the LED in that 
location of the specified strip. -1 correlates to spots that have no 
mapped LED, which are ignored when writing to the arrays. The end result
 of creating this graphical representation was the development of a 
4-zone system of 2D arrays.</p>



<ul><li>Zone 0: Right</li><li>Zone 1: Front</li><li>Zone 2: Left</li><li>Zone 3: Top</li></ul>



<p>Each zone can be written to in 1 of 3 ways. Firstly, the entire zone 
can be set to one color, which is used for the simpler animations. 
Secondly, an entire row or an entire column can be set to a specific 
color. And finally, any specific LED can be set by its row/column 
coordinate pair, which is defined along the axes of the above map.</p>



<p>Converting this map into software was tedious but not as challenging 
as it could have been. I created a class to represent the full cloud, 
and once initialized, the developer can create segments out of the three
 existing strips and then map them to specified coordinates with 
specified orientations. Due to the organization of the strips, this 
resulted in a lot of configuration-related lines of code.</p>



<pre class="wp-block-code"><code>x segmentation

// levels
led_segment_t* level_0 = led_ctrl-&gt;createSegment(strip_t::S_R12, 0, 23);
led_segment_t* level_1 = led_ctrl-&gt;createSegment(strip_t::S_R12, 23, 23);
led_segment_t* level_2 = led_ctrl-&gt;createSegment(strip_t::S_R34, 0, 21);
led_segment_t* level_3 = led_ctrl-&gt;createSegment(strip_t::S_R34, 21, 19);
led_ctrl-&gt;mapSegmentToLevel(level_0, 0);
led_ctrl-&gt;mapSegmentToLevel(level_1, 1);
led_ctrl-&gt;mapSegmentToLevel(level_2, 2);
led_ctrl-&gt;mapSegmentToLevel(level_3, 3);

// right zone
led_segment_t* z_0__0 = led_ctrl-&gt;createSegment(strip_t::S_R12, 0, 5);
led_segment_t* z_0__1 = led_ctrl-&gt;createSegment(strip_t::S_R12, 41, 5);
led_segment_t* z_0__2 = led_ctrl-&gt;createSegment(strip_t::S_R34, 0, 1);
led_ctrl-&gt;mapSegmentToZone(z_0__0, zone_t::RIGHT, 0, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_0__1, zone_t::RIGHT, 1, 4, seg_o_t::ROW_NEG);
led_ctrl-&gt;mapSegmentToZone(z_0__2, zone_t::RIGHT, 2, 4, seg_o_t::ROW_POS);

// front zone
led_segment_t* z_1__0 = led_ctrl-&gt;createSegment(strip_t::S_R12, 5, 12);
led_segment_t* z_1__1 = led_ctrl-&gt;createSegment(strip_t::S_R12, 28, 13);
led_segment_t* z_1__2 = led_ctrl-&gt;createSegment(strip_t::S_R34, 1, 13);
led_segment_t* z_1__3 = led_ctrl-&gt;createSegment(strip_t::S_R34, 24, 11);
led_segment_t* z_1__4 = led_ctrl-&gt;createSegment(strip_t::S_R34, 35, 1);
led_ctrl-&gt;mapSegmentToZone(z_1__0, zone_t::FRONT, 0, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_1__1, zone_t::FRONT, 1, 12, seg_o_t::ROW_NEG);
led_ctrl-&gt;mapSegmentToZone(z_1__2, zone_t::FRONT, 2, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_1__3, zone_t::FRONT, 3, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_1__4, zone_t::FRONT, 3, 12, seg_o_t::ROW_POS);

// left zone
led_segment_t* z_2__0 = led_ctrl-&gt;createSegment(strip_t::S_R12, 17, 6);
led_segment_t* z_2__1 = led_ctrl-&gt;createSegment(strip_t::S_R12, 23, 5);
led_segment_t* z_2__2 = led_ctrl-&gt;createSegment(strip_t::S_R34, 14, 7);
led_ctrl-&gt;mapSegmentToZone(z_2__0, zone_t::LEFT, 0, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_2__1, zone_t::LEFT, 1, 4, seg_o_t::ROW_NEG);
led_ctrl-&gt;mapSegmentToZone(z_2__2, zone_t::LEFT, 2, 0, seg_o_t::ROW_POS);

// top zone
led_segment_t* z_3__0 = led_ctrl-&gt;createSegment(strip_t::S_TOP, 0, 11);
led_segment_t* z_3__1 = led_ctrl-&gt;createSegment(strip_t::S_TOP, 11, 12);
led_segment_t* z_3__2 = led_ctrl-&gt;createSegment(strip_t::S_TOP, 23, 12);
led_segment_t* z_3__3 = led_ctrl-&gt;createSegment(strip_t::S_TOP, 35, 13);
led_segment_t* z_3__4 = led_ctrl-&gt;createSegment(strip_t::S_TOP, 48, 12);
led_segment_t* z_3__5 = led_ctrl-&gt;createSegment(strip_t::S_R34, 21, 3);
led_segment_t* z_3__6 = led_ctrl-&gt;createSegment(strip_t::S_R34, 36, 6);
led_segment_t* z_3__7 = led_ctrl-&gt;createSegment(strip_t::S_R34, 42, 1);
led_ctrl-&gt;mapSegmentToZone(z_3__0, zone_t::TOP, 0, 2, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_3__1, zone_t::TOP, 1, 12, seg_o_t::ROW_NEG);
led_ctrl-&gt;mapSegmentToZone(z_3__2, zone_t::TOP, 2, 1, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_3__3, zone_t::TOP, 3, 12, seg_o_t::ROW_NEG);
led_ctrl-&gt;mapSegmentToZone(z_3__4, zone_t::TOP, 4, 0, seg_o_t::ROW_POS);
led_ctrl-&gt;mapSegmentToZone(z_3__5, zone_t::TOP, 2, 0, seg_o_t::COLUMN_NEG);
led_ctrl-&gt;mapSegmentToZone(z_3__6, zone_t::TOP, 0, 13, seg_o_t::COLUMN_POS);
led_ctrl-&gt;mapSegmentToZone</code></pre>



<h3><em>Animations</em></h3>



<p>In order to actually visualize music, the LEDs need to have patterns 
made and written to them. This is all done using the Animations class. 
At the root of this class, there are two basic functions, then three 
sub-classes contain all the other animations. The two basic functions 
consist of an allOff() that shuts off all LEDs and a diagnostics() that 
runs a diagnostics animation on all the LED pixels to ensure that 
mapping was done correctly.</p>



<p>The first sub-class is not used as of now. This is the 
Animations::Standby class. This consists of sparsely implemented 
functions that can do basic ambient animations for when no audio is 
detected, but this will be done in future iterations.</p>



<p>The second sub-class contains the simpler animations. The 
Animations::Simple class consists of the simple bass side pulse, the 
bass range pulse, and the bass treble pulse animations. They are titled 
with “pulse” as they correlate directly to signal strength in the 
specified signal band. These are the first three accessible animations 
when using the mode button.</p>



<p>The third and final sub-class contains the more advanced animations. 
The Animations::Advanced class contains the historical linear 
visualizers that are the 4th and 5th modes of operation. This is the 
rainbow and fire visualizers. These require a lot more math and some 
data persistence, so they were put in this Advanced child class.</p>



<h4>List of All Animations</h4>



<ol><li><strong>Bass Pulse</strong> (<em>Default at Start-UP</em>) – The left and right sides pulse red with the bass frequencies of each side respectively</li><li><strong>Bass Range Pulse</strong> – Bass range and low mids broken down into different regions for each side and controlled by the respective frequencies</li><li><strong>Bass Treble Pulse</strong> – Bass and Treble ranges are mapped to different regions of the cloud which are illuminated by their associated frequencies</li><li><strong>Linear Visualizer [Rainbow]</strong>
 – A visualizer for a  subset of frequency ranges providing a pleasant 
scrolling animation,  with each range having its own color, forming a 
rainbow</li><li><strong>Linear Visualizer [Fire]</strong> – A visualizer
 for a  subset of frequency ranges providing a pleasant scrolling 
animation,  with the current data being white, and the recent data being
 red, then  orange, then yellow, then a soft white</li></ol>



<h3><em>Control</em></h3>



<h4>De-bouncing and Use of the Mode Button</h4>



<p>In order to prevent a single press from registering as multiple press
 due to the mechanical reality of buttons, de-bouncing is needed. This 
can be done electrically using a resistor/capacitor circuit as done 
here. Adding hysteresis can help smooth things even more. Even with the 
best R/C circuit I could design with what I have, one click would 
register as 2 or 3.</p>



<p>To fix this in software, I created a single byte of history. If a 
press is registered, the first bit is set to 1. If all other bits are 0,
 this is registered as a valid click. If any are 1, it is ignored. 
History is created by shifting the bits left every 1ms using a timer 
interrupt. Therefore, only 1 click every 8ms can be registered as valid.</p>



<pre class="wp-block-code"><code>uint8_t led_mode = 0;
uint8_t hysteresis = 0x00;

/**
 * @brief Initialize the mode button control
 * 
 */
void io_init_mode_control(void) {
	pinMode(LED_MODE_PIN, INPUT);
	attachInterrupt(digitalPinToInterrupt(LED_MODE_PIN), io_change_mode, FALLING);

	shift_timer.begin(__io_mode_shift, 1000); 
}

/**
 * @brief Shift the hysteresis varaible to add a software debounce to the existing hardware debounce
 * 
 */
void __io_mode_shift(void) { hysteresis &lt;&lt;= 1; }

/**
 * @brief Update the LED mode when the button is pressed, taking into account the last 8000us of readings to software debounce the input
 * 
 */
void io_change_mode(void) {
	if (!hysteresis) {
		if (++led_mode == LED_NUM_MODES) { led_mode = 0; }
		hysteresis |= 0x1;
	}
}

/**
 * @brief Get the current mode to be running in
 * 
 * @return uint8_t The mode
 */
uint8_t io_get_mode(void) { return led_mode; }</code></pre>



<p>This eliminated all cases of button bounce. Now, with each valid 
press, a global mode variable is either incremented or wrapped back to 0
 if it exceeds the highest mode that is present.</p>



<h4>Status LED</h4>

<div class="jetpack-video-wrapper"><span class="embed-youtube" style="text-align:center; display: block;"><iframe class="youtube-player" type="text/html" src="https://www.youtube.com/embed/9jOw7xep8F8" allowfullscreen="true" style="border: 0px none; display: block; margin: 0px; width: 685px; height: 385.655px;" data-ratio="0.563" data-width="1000" data-height="563"></iframe></span></div>

<pre class="wp-block-code"><code>/**
 * @brief Set the Common Anode RGB status LED color
 * 
 * @param r Red component (0 - 255)
 * @param g Green component (0 - 255)
 * @param b Blue component (0 - 255)
 */
void __io_write_status_led(uint8_t r, uint8_t g, uint8_t b) {
	analogWrite(S_LED_R, 255 - r);
	analogWrite(S_LED_G, 255 - g);
	analogWrite(S_LED_B, 255 - b);
}</code></pre>



<p>In order to indicate status, a common-anode RGB LED is used. This is 
controlled by three different signals using analogWrite, one for each 
color component. System states are defined in the table below.</p>



<table class="wp-block-table"><tbody><tr><td><strong>Color</strong></td><td><strong>State</strong></td></tr><tr><td><span style="color:Gold">Yellow</span></td><td>System start up initiated and in progress</td></tr><tr><td><span style="color:LightGreen">Green</span></td><td>System is ready and running</td></tr><tr><td><span style="color:RoyalBlue">Blue</span></td><td>System is in a state-transition between LED animation modes</td></tr></tbody></table>



<h2>Final Source and External Resources Used</h2>



<p><strong><em>Final Source Code</em></strong><br>The project repository can be found <a href="https://github.com/MikaylaFischler/light-art-sound-cloud">here</a>.</p>



<p>The release (<em>v1.1</em>) for the demo can be found <a href="https://github.com/MikaylaFischler/light-art-sound-cloud/releases/tag/v1.1">here</a>. More details can be found on the prior release (v1.0) which is <a href="https://github.com/MikaylaFischler/light-art-sound-cloud/releases/tag/v1.0">here</a>.</p>



<p><strong><em>Software Used</em></strong><br><a href="https://www.arduino.cc/en/Main/Software">Arduino</a><br><a href="https://www.pjrc.com/teensy/teensyduino.html">Teensyduino</a></p>



<p><strong><em>Libraries Used</em></strong><br><a href="https://github.com/adafruit/Adafruit_NeoPixel">Adafruit NeoPixel Library</a><br><a href="https://github.com/PaulStoffregen/Audio">Teensy Audio Library</a><br><a href="https://github.com/PaulStoffregen/Wire">Teensy I2C Libray</a></p>



<h2>Thanks</h2>



<p>I want to say thank you to Professor Rosenstock for having this 
course and providing very useful guidance to me and the rest of the 
class and I would like to thank the other students who helped me solve 
some hurdles I encountered in the physical design of the cloud.</p>



<p><br><br></p>
					</div><!-- .entry-content -->

			</div><!-- .entry-inner -->
</article>


			
	
		
		


	</main>


		</div>

		

	</div>
</div>

	





















		

		





</body></html>